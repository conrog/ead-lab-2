<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <link rel="stylesheet" href=""> -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        /* border: 1px solid black; */
      }

      #buttons {
        /* border: 1px solid green; */
        text-align: center;
        padding-bottom: 1rem;
      }

      #container {
        /* border: 1px solid red; */
        width: 80%;
        margin: auto;
      }

      table {
        width: 80%;
        margin: auto;
        border: 1px solid blue;
        font-family: arial, sans-serif;
        border-collapse: collapse;
        display: none;
      }

      td,
      th {
        border: 1px solid lightgrey;
        text-align: left;
        padding: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="buttons">
        <h1>Country Website</h1>
        <p id="loading-status"></p>
        <button id="load-files" onclick="">Load Files</button>
        <button id="show-more" onclick="">Show More</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Number</th>
            <th>Country</th>
            <th>Capital</th>
            <th>Continent</th>
            <th>Coastline</th>
            <th>Currency</th>
            <th>Internet Domains</th>
            <th>Flag</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <!-- <script src="/app.js" async defer></script> -->
  </body>

  <script>
    let countryTableData = []; //Object used to store fetched data
    let showAllRows = false;

    // Function that merges json data from server into a single object
    // whose key is the name of a country and value is an array of data
    // asssoicated with that country
    // Parameters:
    // - array is the array of fetched json data to be iterated over
    // - keyName is the name of the key of the object
    // - valueName is the name of the object property
    // function processFetchedData(array, keyName, valueName) {
    //   for (let i = 0; i < array.length; i++) {
    //     let key = array[i][keyName];
    //     let value = array[i][valueName];
    //     if (countryTableData.hasOwnProperty(key)) {
    //       countryTableData[key].push(value);
    //     } else {
    //       countryTableData[key] = [value];
    //     }
    //   }
    // }

    async function getCountryData() {
      let countries = [];
      try {
        //Asynchronously request all json files from the server
        const [capitals, continents, costlines, currencies, domains, flags] =
          await Promise.all([
            $.ajax("/country-by-capital-city.json"),
            $.ajax("/country-by-continent.json"),
            $.ajax("/country-by-costline.json"),
            $.ajax("/country-by-currency-name.json"),
            $.ajax("/country-by-domain-tld.json"),
            $.ajax("/country-by-flag.json"),
          ]);

        //Merge all fetched data into single object
        // processFetchedData(capitals, "country", "city");
        // processFetchedData(contients, "country", "continent");
        // processFetchedData(costlines, "country", "costline");
        // processFetchedData(currencies, "country", "currency_name");
        // processFetchedData(domains, "country", "tld");
        // processFetchedData(flags, "country", "flag_base64");

        //Create 2-D Array with each element consisting of the data related to each country
        //from the json files on the server
        for (let i = 0; i < capitals.length; i++) {
          countries.push([
            capitals[i].country,
            capitals[i].city,
            continents[i].continent,
            costlines[i].costline,
            currencies[i].currency_name,
            domains[i].tld,
            flags[i].flag_base64,
          ]);
        }

        console.log(countryTableData);
      } catch (error) {
        console.log(error);
      }

      return countries;
    }

    //Function that takes the 2-d country array and creates the table
    function displayTableData(countries) {
      let tableBody = document.getElementById("table-body");

      tableBody.innerHTML = "";
      //Array of arrays containing country data
      countries.forEach((country, index) => {
        let tableRow = document.createElement("tr");
        let countryIndex = document.createElement("td");
        countryIndex.innerText = index + 1;
        tableRow.appendChild(countryIndex);

        //Array of country data
        country.forEach((item, index) => {
          let tableData = document.createElement("td");
          if (item === null) {
            tableData.textContent = "N/A"; //Display for null values in table
          } else {
            if (index === 6) {
              let image = document.createElement("img");
              image.src = item;
              image.height = 25;
              image.width = 25;
              tableData.appendChild(image);
            } else {
              tableData.textContent = item;
            }
          }

          tableRow.appendChild(tableData);
          $("table").fadeIn(2000).css("display", "table");
        });

        document.getElementById("table-body").appendChild(tableRow);
      });
    }

    // Button listener for fetching json files from server
    $("#load-files").on("click", async () => {
      $("#loading-status").text("Loading files from server...");
      let countries = await getCountryData();
      //Set Timeout for 5 seconds to simiulate loading
      setTimeout(() => {
        displayTableData(countries);

        $("#loading-status").text(
          "The files in folder '/country-objects' have been read!"
        );
        $("#table-body tr:gt(19)").hide();
      }, 5000);
    });

    // Button listener for hiding/showing more than 20 countries in the table
    $("#show-more").on("click", (event) => {
      if (event.currentTarget.innerText === "Show More") {
        $("#table-body tr:gt(19)").show();
        event.currentTarget.innerText = "Show Less";
      } else {
        $("#table-body tr:gt(19)").hide();
        event.currentTarget.innerText = "Show More";
      }
    });

    $("#loading-status").on("click", (event) => {
      $("#loading-status").fadeOut(1000);
    });
  </script>
</html>
